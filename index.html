<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم مساري - نظام إدارة السائقين</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap RTL -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
    
    <!-- Leaflet CSS for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Custom CSS -->
    <style>
        :root {
            --primary-color: #6366F1;
            --secondary-color: #EC4899;
            --success-color: #10B981;
            --warning-color: #F59E0B;
            --danger-color: #EF4444;
            --info-color: #3B82F6;
            --dark-color: #1F2937;
            --light-color: #F9FAFB;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #F3F4F6;
            color: #1F2937;
        }
        
        /* Sidebar Styles */
        .sidebar {
            height: 100vh;
            width: 280px;
            position: fixed;
            top: 0;
            right: 0;
            background-color: var(--dark-color);
            padding-top: 60px;
            z-index: 100;
            transition: all 0.3s;
            overflow-y: auto;
        }
        
        .sidebar.collapsed {
            width: 80px;
        }
        
        .sidebar-logo {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }
        
        .sidebar-logo h3 {
            color: white;
            font-weight: 700;
            margin: 0;
        }
        
        .sidebar-menu {
            list-style: none;
            padding: 0;
        }
        
        .sidebar-menu li {
            margin-bottom: 5px;
        }
        
        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.2s;
        }
        
        .sidebar-menu a:hover, .sidebar-menu a.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .sidebar-menu i {
            margin-left: 10px;
            font-size: 18px;
            width: 20px;
            text-align: center;
        }
        
        /* Main Content */
        .main-content {
            margin-right: 280px;
            padding: 20px;
            transition: all 0.3s;
            min-height: 100vh;
        }
        
        .main-content.expanded {
            margin-right: 80px;
        }
        
        /* Top Bar */
        .top-bar {
            background-color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .search-bar {
            position: relative;
            width: 300px;
        }
        
        .search-bar input {
            width: 100%;
            padding: 8px 15px 8px 40px;
            border: 1px solid #E5E7EB;
            border-radius: 20px;
            outline: none;
        }
        
        .search-bar i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #9CA3AF;
        }
        
        .user-info {
            display: flex;
            align-items: center;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 10px;
        }
        
        /* Cards */
        .card {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #E5E7EB;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }
        
        /* Stats Cards */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 15px;
            font-size: 24px;
            color: white;
        }
        
        .stat-info h3 {
            font-size: 24px;
            font-weight: 700;
            margin: 0 0 5px 0;
        }
        
        .stat-info p {
            margin: 0;
            color: #6B7280;
        }
        
        /* Tables */
        .table-container {
            overflow-x: auto;
        }
        
        .custom-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .custom-table th {
            background-color: #F9FAFB;
            padding: 12px 15px;
            text-align: right;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #E5E7EB;
        }
        
        .custom-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #F3F4F6;
        }
        
        .custom-table tr:hover {
            background-color: #F9FAFB;
        }
        
        /* Status Badges */
        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-active {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }
        
        .status-inactive {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }
        
        .status-pending {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }
        
        /* Buttons */
        .btn-primary-custom {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary-custom:hover {
            background-color: var(--primary-dark);
        }
        
        .btn-success-custom {
            background-color: var(--success-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-danger-custom {
            background-color: var(--danger-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        /* Map Container */
        #map {
            height: 500px;
            width: 100%;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #E5E7EB;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        /* Modal */
        .modal-content {
            border-radius: 10px;
            border: none;
        }
        
        .modal-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0;
        }
        
        .modal-title {
            font-weight: 600;
        }
        
        .btn-close {
            filter: invert(1);
        }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background-color: #E5E7EB;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .toggle-switch.active {
            background-color: var(--success-color);
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 50%;
            top: 2px;
            right: 2px;
            transition: transform 0.3s;
        }
        
        .toggle-switch.active::after {
            transform: translateX(-26px);
        }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 3px solid var(--primary-color);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 80px;
            }
            
            .sidebar-menu span {
                display: none;
            }
            
            .main-content {
                margin-right: 80px;
            }
            
            .search-bar {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-logo">
            <h3>مساري</h3>
        </div>
        <ul class="sidebar-menu">
            <li>
                <a href="#" class="active" data-section="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>لوحة التحكم</span>
                </a>
            </li>
            <li>
                <a href="#" data-section="drivers">
                    <i class="fas fa-users"></i>
                    <span>السائقين</span>
                </a>
            </li>
            <li>
                <a href="#" data-section="wallet">
                    <i class="fas fa-wallet"></i>
                    <span>إدارة الرصيد</span>
                </a>
            </li>
            <li>
                <a href="#" data-section="tracking">
                    <i class="fas fa-map-marked-alt"></i>
                    <span>مراقبة خطوط السير</span>
                </a>
            </li>
            <li>
                <a href="#" data-section="controls">
                    <i class="fas fa-sliders-h"></i>
                    <span>التحكم والضبط</span>
                </a>
            </li>
            <li>
                <a href="#" data-section="reports">
                    <i class="fas fa-chart-bar"></i>
                    <span>التقارير والتحليلات</span>
                </a>
            </li>
            <li>
                <a href="#" data-section="security">
                    <i class="fas fa-shield-alt"></i>
                    <span>الأمان والتوثيق</span>
                </a>
            </li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="d-flex align-items-center">
                <button class="btn btn-outline-secondary me-3" type="button" id="toggleSidebar">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="بحث...">
                </div>
            </div>
            <div class="user-info">
                <span class="me-2">المشرف</span>
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard-section" class="content-section">
            <h2 class="mb-4">لوحة التحكم</h2>
            
            <!-- Stats Cards -->
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-icon" style="background-color: var(--primary-color);">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalDrivers">0</h3>
                        <p>إجمالي السائقين</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background-color: var(--success-color);">
                        <i class="fas fa-user-check"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="activeDrivers">0</h3>
                        <p>السائقين النشطين</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background-color: var(--warning-color);">
                        <i class="fas fa-route"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="todayTrips">0</h3>
                        <p>الرحلات اليوم</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background-color: var(--info-color);">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalRevenue">0</h3>
                        <p>إجمالي الإيرادات</p>
                    </div>
                </div>
            </div>
            
            <!-- Recent Activities -->
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">الأنشطة الحديثة</h4>
                </div>
                <div class="table-container">
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th>السائق</th>
                                <th>النشاط</th>
                                <th>الوقت</th>
                                <th>الحالة</th>
                            </tr>
                        </thead>
                        <tbody id="recentActivities">
                            <!-- Activities will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Drivers Section -->
        <div id="drivers-section" class="content-section" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2 class="card-title mb-0">إدارة السائقين</h2>
                <button class="btn-primary-custom" data-bs-toggle="modal" data-bs-target="#addDriverModal">
                    <i class="fas fa-plus me-2"></i>إضافة سائق جديد
                </button>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">قائمة السائقين</h4>
                    <div class="d-flex">
                        <input type="text" class="form-control me-2" placeholder="بحث بالاسم أو رقم الهاتف" id="driverSearch">
                        <select class="form-control" id="driverStatusFilter">
                            <option value="">جميع الحالات</option>
                            <option value="active">نشط</option>
                            <option value="inactive">غير نشط</option>
                            <option value="pending">في الانتظار</option>
                        </select>
                    </div>
                </div>
                <div class="table-container">
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th>الاسم</th>
                                <th>رقم الهاتف</th>
                                <th>السيارة</th>
                                <th>الرصيد</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="driversTable">
                            <!-- Drivers will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Wallet Section -->
        <div id="wallet-section" class="content-section" style="display: none;">
            <h2 class="mb-4">إدارة الرصيد</h2>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">شحن رصيد السائق</h4>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="driverSelect">اختر السائق</label>
                                <select class="form-control" id="driverSelect">
                                    <option value="">-- اختر سائق --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="rechargeAmount">المبلغ</label>
                                <input type="number" class="form-control" id="rechargeAmount" placeholder="أدخل المبلغ">
                            </div>
                            <div class="form-group">
                                <label for="paymentMethod">طريقة الدفع</label>
                                <select class="form-control" id="paymentMethod">
                                    <option value="cash">نقدي</option>
                                    <option value="bank">تحويل بنكي</option>
                                    <option value="mtn">MTN Mobile Money</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="rechargeNote">ملاحظات</label>
                                <textarea class="form-control" id="rechargeNote" rows="3"></textarea>
                            </div>
                            <button class="btn-success-custom w-100" id="rechargeBtn">
                                <i class="fas fa-plus-circle me-2"></i>شحن الرصيد
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">خصم الرصيد</h4>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="deductDriverSelect">اختر السائق</label>
                                <select class="form-control" id="deductDriverSelect">
                                    <option value="">-- اختر سائق --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="deductAmount">المبلغ</label>
                                <input type="number" class="form-control" id="deductAmount" placeholder="أدخل المبلغ">
                            </div>
                            <div class="form-group">
                                <label for="deductReason">السبب</label>
                                <select class="form-control" id="deductReason">
                                    <option value="penalty">غرامة</option>
                                    <option value="maintenance">صيانة</option>
                                    <option value="other">أخرى</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="deductNote">ملاحظات</label>
                                <textarea class="form-control" id="deductNote" rows="3"></textarea>
                            </div>
                            <button class="btn-danger-custom w-100" id="deductBtn">
                                <i class="fas fa-minus-circle me-2"></i>خصم الرصيد
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card mt-4">
                <div class="card-header">
                    <h4 class="card-title">سجل المعاملات</h4>
                </div>
                <div class="table-container">
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th>التاريخ</th>
                                <th>السائق</th>
                                <th>النوع</th>
                                <th>المبلغ</th>
                                <th>السبب</th>
                                <th>المشغل</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTable">
                            <!-- Transactions will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tracking Section -->
        <div id="tracking-section" class="content-section" style="display: none;">
            <h2 class="mb-4">مراقبة خطوط السير</h2>
            
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">الخريطة المباشرة</h4>
                    <div>
                        <button class="btn-primary-custom me-2" id="refreshMap">
                            <i class="fas fa-sync-alt me-2"></i>تحديث
                        </button>
                        <select class="form-control d-inline-block w-auto" id="driverFilter">
                            <option value="">جميع السائقين</option>
                        </select>
                    </div>
                </div>
                <div id="map"></div>
            </div>
            
            <div class="card mt-4">
                <div class="card-header">
                    <h4 class="card-title">معلومات السائقين النشطين</h4>
                </div>
                <div class="table-container">
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th>السائق</th>
                                <th>الموقع الحالي</th>
                                <th>آخر تحديث</th>
                                <th>الرحلات اليوم</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="activeDriversTable">
                            <!-- Active drivers will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Controls Section -->
        <div id="controls-section" class="content-section" style="display: none;">
            <h2 class="mb-4">التحكم والضبط</h2>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">إيقاف سائق مؤقتاً</h4>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="suspendDriverSelect">اختر السائق</label>
                                <select class="form-control" id="suspendDriverSelect">
                                    <option value="">-- اختر سائق --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="suspendReason">سبب الإيقاف</label>
                                <textarea class="form-control" id="suspendReason" rows="3"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="suspendDuration">مدة الإيقاف</label>
                                <select class="form-control" id="suspendDuration">
                                    <option value="1">يوم واحد</option>
                                    <option value="3">3 أيام</option>
                                    <option value="7">أسبوع</option>
                                    <option value="30">شهر</option>
                                    <option value="indefinite">غير محدد</option>
                                </select>
                            </div>
                            <button class="btn-danger-custom w-100" id="suspendBtn">
                                <i class="fas fa-ban me-2"></i>إيقاف السائق
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">تحديد منطقة العمل</h4>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="workAreaName">اسم المنطقة</label>
                                <input type="text" class="form-control" id="workAreaName" placeholder="مثال: صنعاء">
                            </div>
                            <div class="form-group">
                                <label for="workAreaRadius">نصف القطر (كم)</label>
                                <input type="number" class="form-control" id="workAreaRadius" placeholder="مثال: 10">
                            </div>
                            <div class="form-group">
                                <label for="workAreaCenter">مركز المنطقة</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="workAreaCenter" placeholder="خط الطول، خط العرض">
                                    <button class="btn-primary-custom" type="button" id="getCurrentLocation">
                                        <i class="fas fa-map-marker-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <button class="btn-success-custom w-100" id="saveWorkAreaBtn">
                                <i class="fas fa-save me-2"></i>حفظ المنطقة
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card mt-4">
                <div class="card-header">
                    <h4 class="card-title">الإشعارات</h4>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="tripNotifications" checked>
                        <label class="form-check-label" for="tripNotifications">
                            إشعارات بدء/انتهاء الرحلات
                        </label>
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="geofenceNotifications" checked>
                        <label class="form-check-label" for="geofenceNotifications">
                            تنبيهات خروج السائق عن منطقة العمل
                        </label>
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="lowBalanceNotifications" checked>
                        <label class="form-check-label" for="lowBalanceNotifications">
                            تنبيهات انخفاض رصيد السائق
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="lowBalanceThreshold">حد انخفاض الرصيد</label>
                        <input type="number" class="form-control" id="lowBalanceThreshold" value="100">
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Section -->
        <div id="reports-section" class="content-section" style="display: none;">
            <h2 class="mb-4">التقارير والتحليلات</h2>
            
            <div class="card mb-4">
                <div class="card-header">
                    <h4 class="card-title">تقرير الأرباح</h4>
                    <div>
                        <select class="form-control d-inline-block w-auto me-2" id="revenuePeriod">
                            <option value="daily">يومي</option>
                            <option value="weekly">أسبوعي</option>
                            <option value="monthly">شهري</option>
                        </select>
                        <button class="btn-primary-custom" id="generateRevenueReport">
                            <i class="fas fa-chart-line me-2"></i>إنشاء تقرير
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="revenueChart" width="400" height="200"></canvas>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header">
                    <h4 class="card-title">تقرير الرحلات</h4>
                    <div>
                        <input type="date" class="form-control d-inline-block w-auto me-2" id="tripStartDate">
                        <input type="date" class="form-control d-inline-block w-auto me-2" id="tripEndDate">
                        <button class="btn-primary-custom" id="generateTripsReport">
                            <i class="fas fa-route me-2"></i>إنشاء تقرير
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="tripsChart" width="400" height="200"></canvas>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">ترتيب السائقين حسب الأداء</h4>
                    <button class="btn-primary-custom" id="generateRankingReport">
                        <i class="fas fa-trophy me-2"></i>إنشاء تقرير
                    </button>
                </div>
                <div class="table-container">
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th>الترتيب</th>
                                <th>السائق</th>
                                <th>الرحلات</th>
                                <th>الأرباح</th>
                                <th>التقييم</th>
                            </tr>
                        </thead>
                        <tbody id="rankingTable">
                            <!-- Ranking data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Security Section -->
        <div id="security-section" class="content-section" style="display: none;">
            <h2 class="mb-4">الأمان والتوثيق</h2>
            
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">طلبات التوثيق المعلقة</h4>
                </div>
                <div class="table-container">
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th>السائق</th>
                                <th>رقم الهاتف</th>
                                <th>المستندات</th>
                                <th>تاريخ الطلب</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="verificationRequests">
                            <!-- Verification requests will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="card mt-4">
                <div class="card-header">
                    <h4 class="card-title">إعدادات الأمان</h4>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="requireDocuments" checked>
                        <label class="form-check-label" for="requireDocuments">
                            طلب المستندات عند التسجيل
                        </label>
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="requirePhoneVerification" checked>
                        <label class="form-check-label" for="requirePhoneVerification">
                            التحقق من رقم الهاتف
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="documentExpiry">انتهاء صلاحية المستندات (أيام)</label>
                        <input type="number" class="form-control" id="documentExpiry" value="365">
                    </div>
                    <div class="form-group">
                        <label for="maxLoginAttempts">محاولات تسجيل الدخول القصوى</label>
                        <input type="number" class="form-control" id="maxLoginAttempts" value="5">
                    </div>
                    <button class="btn-success-custom w-100" id="saveSecuritySettings">
                        <i class="fas fa-save me-2"></i>حفظ الإعدادات
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Driver Modal -->
    <div class="modal fade" id="addDriverModal" tabindex="-1" aria-labelledby="addDriverModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addDriverModalLabel">إضافة سائق جديد</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addDriverForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="driverName">الاسم الكامل</label>
                                    <input type="text" class="form-control" id="driverName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="driverPhone">رقم الهاتف</label>
                                    <input type="tel" class="form-control" id="driverPhone" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="driverEmail">البريد الإلكتروني</label>
                                    <input type="email" class="form-control" id="driverEmail">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="driverPassword">كلمة المرور</label>
                                    <input type="password" class="form-control" id="driverPassword" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="carModel">موديل السيارة</label>
                                    <input type="text" class="form-control" id="carModel" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="carPlate">رقم اللوحة</label>
                                    <input type="text" class="form-control" id="carPlate" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="carColor">لون السيارة</label>
                                    <input type="text" class="form-control" id="carColor">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="initialBalance">الرصيد الأولي</label>
                                    <input type="number" class="form-control" id="initialBalance" value="0">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="driverNotes">ملاحظات</label>
                            <textarea class="form-control" id="driverNotes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn-primary-custom" id="saveDriverBtn">حفظ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Driver Details Modal -->
    <div class="modal fade" id="driverDetailsModal" tabindex="-1" aria-labelledby="driverDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="driverDetailsModalLabel">تفاصيل السائق</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="driverDetailsContent">
                    <!-- Driver details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                    <button type="button" class="btn-primary-custom" id="editDriverBtn">تعديل</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Document Verification Modal -->
    <div class="modal fade" id="documentModal" tabindex="-1" aria-labelledby="documentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="documentModalLabel">التحقق من المستندات</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="documentContent">
                    <!-- Document details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="rejectDocumentBtn">رفض</button>
                    <button type="button" class="btn btn-success" id="approveDocumentBtn">موافقة</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
  apiKey: "AIzaSyCdDqQXXeT2AVwHP47c6uUe60ZXoj5cc2M",
  authDomain: "addpr-4c2cc.firebaseapp.com",
  databaseURL: "https://addpr-4c2cc-default-rtdb.firebaseio.com",
  projectId: "addpr-4c2cc",
  storageBucket: "addpr-4c2cc.firebasestorage.app",
  messagingSenderId: "520324533363",
  appId: "1:520324533363:web:416a90f29ea870afd46e06",
  measurementId: "G-JB41604WLD"
};

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // Global Variables
        let map;
        let drivers = [];
        let markers = [];
        let currentSection = 'dashboard';

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // Initialize map
            initializeMap();
            
            // Load initial data
            loadDashboardData();
            
            // Setup event listeners
            setupEventListeners();
            
            // Check authentication
            checkAuth();
        }

        function initializeMap() {
            map = L.map('map').setView([15.3694, 44.1910], 12); // Default to Sana'a, Yemen
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
        }

        function setupEventListeners() {
            // Sidebar toggle
            document.getElementById('toggleSidebar').addEventListener('click', function() {
                document.getElementById('sidebar').classList.toggle('collapsed');
                document.getElementById('mainContent').classList.toggle('expanded');
            });

            // Navigation
            document.querySelectorAll('.sidebar-menu a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.getAttribute('data-section');
                    showSection(section);
                    
                    // Update active state
                    document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // Add driver form
            document.getElementById('saveDriverBtn').addEventListener('click', saveDriver);

            // Recharge button
            document.getElementById('rechargeBtn').addEventListener('click', rechargeDriver);

            // Deduct button
            document.getElementById('deductBtn').addEventListener('click', deductDriver);

            // Suspend button
            document.getElementById('suspendBtn').addEventListener('click', suspendDriver);

            // Save work area button
            document.getElementById('saveWorkAreaBtn').addEventListener('click', saveWorkArea);

            // Get current location button
            document.getElementById('getCurrentLocation').addEventListener('click', getCurrentLocation);

            // Refresh map button
            document.getElementById('refreshMap').addEventListener('click', refreshMap);

            // Generate reports buttons
            document.getElementById('generateRevenueReport').addEventListener('click', generateRevenueReport);
            document.getElementById('generateTripsReport').addEventListener('click', generateTripsReport);
            document.getElementById('generateRankingReport').addEventListener('click', generateRankingReport);

            // Save security settings button
            document.getElementById('saveSecuritySettings').addEventListener('click', saveSecuritySettings);

            // Driver search
            document.getElementById('driverSearch').addEventListener('input', filterDrivers);

            // Driver status filter
            document.getElementById('driverStatusFilter').addEventListener('change', filterDrivers);

            // Driver filter for map
            document.getElementById('driverFilter').addEventListener('change', filterMapDrivers);
        }

        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Show selected section
            document.getElementById(`${sectionId}-section`).style.display = 'block';
            currentSection = sectionId;
            
            // Load section-specific data
            switch(sectionId) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'drivers':
                    loadDrivers();
                    break;
                case 'wallet':
                    loadWalletData();
                    break;
                case 'tracking':
                    loadTrackingData();
                    break;
                case 'controls':
                    loadControlsData();
                    break;
                case 'reports':
                    loadReportsData();
                    break;
                case 'security':
                    loadSecurityData();
                    break;
            }
        }

        function checkAuth() {
            auth.onAuthStateChanged(user => {
                if (!user) {
                    // Redirect to login page
                    window.location.href = 'login.html';
                }
            });
        }

        // Dashboard Functions
        function loadDashboardData() {
            // Load stats
            db.collection('drivers').get().then(snapshot => {
                const totalDrivers = snapshot.size;
                const activeDrivers = snapshot.docs.filter(doc => doc.data().status === 'active').length;
                
                document.getElementById('totalDrivers').textContent = totalDrivers;
                document.getElementById('activeDrivers').textContent = activeDrivers;
            });

            // Load today's trips
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            db.collection('trips')
                .where('date', '>=', today)
                .get()
                .then(snapshot => {
                    document.getElementById('todayTrips').textContent = snapshot.size;
                });

            // Load total revenue
            db.collection('transactions')
                .where('type', '==', 'recharge')
                .get()
                .then(snapshot => {
                    let totalRevenue = 0;
                    snapshot.forEach(doc => {
                        totalRevenue += parseFloat(doc.data().amount);
                    });
                    document.getElementById('totalRevenue').textContent = totalRevenue.toFixed(2);
                });

            // Load recent activities
            loadRecentActivities();
        }

        function loadRecentActivities() {
            const activitiesTable = document.getElementById('recentActivities');
            activitiesTable.innerHTML = '';
            
            db.collection('activities')
                .orderBy('timestamp', 'desc')
                .limit(10)
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        activitiesTable.innerHTML = '<tr><td colspan="4" class="text-center">لا توجد أنشطة حديثة</td></tr>';
                        return;
                    }
                    
                    snapshot.forEach(doc => {
                        const activity = doc.data();
                        const row = document.createElement('tr');
                        
                        let statusClass = '';
                        let statusText = '';
                        
                        switch(activity.status) {
                            case 'active':
                                statusClass = 'status-active';
                                statusText = 'نشط';
                                break;
                            case 'inactive':
                                statusClass = 'status-inactive';
                                statusText = 'غير نشط';
                                break;
                            case 'pending':
                                statusClass = 'status-pending';
                                statusText = 'في الانتظار';
                                break;
                        }
                        
                        row.innerHTML = `
                            <td>${activity.driverName}</td>
                            <td>${activity.action}</td>
                            <td>${formatDate(activity.timestamp)}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        `;
                        
                        activitiesTable.appendChild(row);
                    });
                });
        }

        // Drivers Functions
        function loadDrivers() {
            const driversTable = document.getElementById('driversTable');
            const driverSelect = document.getElementById('driverSelect');
            const deductDriverSelect = document.getElementById('deductDriverSelect');
            const suspendDriverSelect = document.getElementById('suspendDriverSelect');
            const driverFilter = document.getElementById('driverFilter');
            
            driversTable.innerHTML = '<tr><td colspan="6" class="text-center"><div class="spinner"></div></td></tr>';
            
            db.collection('drivers').get().then(snapshot => {
                drivers = [];
                driversTable.innerHTML = '';
                driverSelect.innerHTML = '<option value="">-- اختر سائق --</option>';
                deductDriverSelect.innerHTML = '<option value="">-- اختر سائق --</option>';
                suspendDriverSelect.innerHTML = '<option value="">-- اختر سائق --</option>';
                driverFilter.innerHTML = '<option value="">جميع السائقين</option>';
                
                if (snapshot.empty) {
                    driversTable.innerHTML = '<tr><td colspan="6" class="text-center">لا يوجد سائقين</td></tr>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const driver = { id: doc.id, ...doc.data() };
                    drivers.push(driver);
                    
                    // Add to dropdowns
                    const option = document.createElement('option');
                    option.value = driver.id;
                    option.textContent = driver.name;
                    driverSelect.appendChild(option);
                    deductDriverSelect.appendChild(option.cloneNode(true));
                    suspendDriverSelect.appendChild(option.cloneNode(true));
                    
                    const filterOption = document.createElement('option');
                    filterOption.value = driver.id;
                    filterOption.textContent = driver.name;
                    driverFilter.appendChild(filterOption);
                    
                    // Add to table
                    const row = document.createElement('tr');
                    
                    let statusClass = '';
                    let statusText = '';
                    
                    switch(driver.status) {
                        case 'active':
                            statusClass = 'status-active';
                            statusText = 'نشط';
                            break;
                        case 'inactive':
                            statusClass = 'status-inactive';
                            statusText = 'غير نشط';
                            break;
                        case 'pending':
                            statusClass = 'status-pending';
                            statusText = 'في الانتظار';
                            break;
                    }
                    
                    row.innerHTML = `
                        <td>${driver.name}</td>
                        <td>${driver.phone}</td>
                        <td>${driver.carModel} - ${driver.carPlate}</td>
                        <td>${driver.balance} ج.س</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary-custom me-1" onclick="viewDriverDetails('${driver.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-success-custom me-1" onclick="toggleDriverStatus('${driver.id}')">
                                <i class="fas fa-toggle-${driver.status === 'active' ? 'on' : 'off'}"></i>
                            </button>
                            <button class="btn btn-sm btn-danger-custom" onclick="deleteDriver('${driver.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    
                    driversTable.appendChild(row);
                });
            });
        }

        function saveDriver() {
            const form = document.getElementById('addDriverForm');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const driverData = {
                name: document.getElementById('driverName').value,
                phone: document.getElementById('driverPhone').value,
                email: document.getElementById('driverEmail').value,
                password: document.getElementById('driverPassword').value,
                carModel: document.getElementById('carModel').value,
                carPlate: document.getElementById('carPlate').value,
                carColor: document.getElementById('carColor').value,
                balance: parseFloat(document.getElementById('initialBalance').value),
                status: 'pending',
                notes: document.getElementById('driverNotes').value,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                totalTrips: 0,
                rating: 0,
                documents: {
                    license: null,
                    insurance: null,
                    idCard: null
                }
            };
            
            db.collection('drivers').add(driverData)
                .then(docRef => {
                    // Log activity
                    logActivity('إضافة سائق جديد', driverData.name, 'pending');
                    
                    // Show success message
                    showAlert('success', 'تم إضافة السائق بنجاح');
                    
                    // Close modal and reset form
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addDriverModal'));
                    modal.hide();
                    form.reset();
                    
                    // Reload drivers
                    loadDrivers();
                })
                .catch(error => {
                    console.error('Error adding driver:', error);
                    showAlert('danger', 'حدث خطأ أثناء إضافة السائق');
                });
        }

        function viewDriverDetails(driverId) {
            const driver = drivers.find(d => d.id === driverId);
            if (!driver) return;
            
            const content = document.getElementById('driverDetailsContent');
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h5>المعلومات الشخصية</h5>
                        <p><strong>الاسم:</strong> ${driver.name}</p>
                        <p><strong>رقم الهاتف:</strong> ${driver.phone}</p>
                        <p><strong>البريد الإلكتروني:</strong> ${driver.email || 'غير محدد'}</p>
                        <p><strong>الحالة:</strong> <span class="status-badge status-${driver.status}">${driver.status === 'active' ? 'نشط' : driver.status === 'inactive' ? 'غير نشط' : 'في الانتظار'}</span></p>
                    </div>
                    <div class="col-md-6">
                        <h5>معلومات السيارة</h5>
                        <p><strong>الموديل:</strong> ${driver.carModel}</p>
                        <p><strong>رقم اللوحة:</strong> ${driver.carPlate}</p>
                        <p><strong>اللون:</strong> ${driver.carColor || 'غير محدد'}</p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h5>المعلومات المالية</h5>
                        <p><strong>الرصيد الحالي:</strong> ${driver.balance} ج.س</p>
                        <p><strong>إجمالي الرحلات:</strong> ${driver.totalTrips || 0}</p>
                        <p><strong>متوسط التقييم:</strong> ${driver.rating || 0}</p>
                    </div>
                    <div class="col-md-6">
                        <h5>معلومات إضافية</h5>
                        <p><strong>تاريخ الإنشاء:</strong> ${formatDate(driver.createdAt)}</p>
                        <p><strong>ملاحظات:</strong> ${driver.notes || 'لا توجد ملاحظات'}</p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h5>المستندات</h5>
                        <div class="row">
                            <div class="col-md-4">
                                <p><strong>رخصة القيادة:</strong></p>
                                ${driver.documents.license ? 
                                    `<img src="${driver.documents.license}" class="img-fluid" alt="License">` : 
                                    '<p class="text-muted">لم يتم رفع المستند</p>'
                                }
                            </div>
                            <div class="col-md-4">
                                <p><strong>التأمين:</strong></p>
                                ${driver.documents.insurance ? 
                                    `<img src="${driver.documents.insurance}" class="img-fluid" alt="Insurance">` : 
                                    '<p class="text-muted">لم يتم رفع المستند</p>'
                                }
                            </div>
                            <div class="col-md-4">
                                <p><strong>بطاقة الهوية:</strong></p>
                                ${driver.documents.idCard ? 
                                    `<img src="${driver.documents.idCard}" class="img-fluid" alt="ID Card">` : 
                                    '<p class="text-muted">لم يتم رفع المستند</p>'
                                }
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Set edit button data
            document.getElementById('editDriverBtn').setAttribute('data-driver-id', driverId);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('driverDetailsModal'));
            modal.show();
        }

        function toggleDriverStatus(driverId) {
            const driver = drivers.find(d => d.id === driverId);
            if (!driver) return;
            
            const newStatus = driver.status === 'active' ? 'inactive' : 'active';
            
            db.collection('drivers').doc(driverId).update({
                status: newStatus,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                // Log activity
                logActivity(`${newStatus === 'active' ? 'تفعيل' : 'إلغاء تفعيل'} السائق`, driver.name, newStatus);
                
                // Show success message
                showAlert('success', `تم ${newStatus === 'active' ? 'تفعيل' : 'إلغاء تفعيل'} السائق بنجاح`);
                
                // Reload drivers
                loadDrivers();
            })
            .catch(error => {
                console.error('Error updating driver status:', error);
                showAlert('danger', 'حدث خطأ أثناء تحديث حالة السائق');
            });
        }

        function deleteDriver(driverId) {
            if (!confirm('هل أنت متأكد من حذف هذا السائق؟')) return;
            
            const driver = drivers.find(d => d.id === driverId);
            if (!driver) return;
            
            db.collection('drivers').doc(driverId).delete()
            .then(() => {
                // Log activity
                logActivity('حذف السائق', driver.name, 'deleted');
                
                // Show success message
                showAlert('success', 'تم حذف السائق بنجاح');
                
                // Reload drivers
                loadDrivers();
            })
            .catch(error => {
                console.error('Error deleting driver:', error);
                showAlert('danger', 'حدث خطأ أثناء حذف السائق');
            });
        }

        function filterDrivers() {
            const searchTerm = document.getElementById('driverSearch').value.toLowerCase();
            const statusFilter = document.getElementById('driverStatusFilter').value;
            
            const rows = document.querySelectorAll('#driversTable tr');
            
            rows.forEach(row => {
                const name = row.cells[0].textContent.toLowerCase();
                const phone = row.cells[1].textContent.toLowerCase();
                const status = row.cells[4].textContent.trim();
                
                const matchesSearch = name.includes(searchTerm) || phone.includes(searchTerm);
                const matchesStatus = !statusFilter || status === statusFilter;
                
                row.style.display = matchesSearch && matchesStatus ? '' : 'none';
            });
        }

        // Wallet Functions
        function loadWalletData() {
            loadTransactions();
        }

        function rechargeDriver() {
            const driverId = document.getElementById('driverSelect').value;
            const amount = parseFloat(document.getElementById('rechargeAmount').value);
            const paymentMethod = document.getElementById('paymentMethod').value;
            const note = document.getElementById('rechargeNote').value;
            
            if (!driverId || !amount || amount <= 0) {
                showAlert('warning', 'الرجاء اختيار سائق وإدخال مبلغ صحيح');
                return;
            }
            
            const driver = drivers.find(d => d.id === driverId);
            if (!driver) return;
            
            // Update driver balance
            db.collection('drivers').doc(driverId).update({
                balance: firebase.firestore.FieldValue.increment(amount),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                // Add transaction record
                db.collection('transactions').add({
                    driverId: driverId,
                    driverName: driver.name,
                    type: 'recharge',
                    amount: amount,
                    paymentMethod: paymentMethod,
                    note: note,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    adminId: auth.currentUser.uid
                });
                
                // Log activity
                logActivity('شحن رصيد', `${driver.name} - ${amount} ج.س`, 'active');
                
                // Show success message
                showAlert('success', 'تم شحن الرصيد بنجاح');
                
                // Reset form
                document.getElementById('driverSelect').value = '';
                document.getElementById('rechargeAmount').value = '';
                document.getElementById('paymentMethod').value = 'cash';
                document.getElementById('rechargeNote').value = '';
                
                // Reload data
                loadTransactions();
                loadDrivers();
            })
            .catch(error => {
                console.error('Error recharging driver:', error);
                showAlert('danger', 'حدث خطأ أثناء شحن الرصيد');
            });
        }

        function deductDriver() {
            const driverId = document.getElementById('deductDriverSelect').value;
            const amount = parseFloat(document.getElementById('deductAmount').value);
            const reason = document.getElementById('deductReason').value;
            const note = document.getElementById('deductNote').value;
            
            if (!driverId || !amount || amount <= 0) {
                showAlert('warning', 'الرجاء اختيار سائق وإدخال مبلغ صحيح');
                return;
            }
            
            const driver = drivers.find(d => d.id === driverId);
            if (!driver) return;
            
            if (driver.balance < amount) {
                showAlert('warning', 'رصيد السائق غير كافي');
                return;
            }
            
            // Update driver balance
            db.collection('drivers').doc(driverId).update({
                balance: firebase.firestore.FieldValue.increment(-amount),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                // Add transaction record
                db.collection('transactions').add({
                    driverId: driverId,
                    driverName: driver.name,
                    type: 'deduction',
                    amount: amount,
                    reason: reason,
                    note: note,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    adminId: auth.currentUser.uid
                });
                
                // Log activity
                logActivity('خصم رصيد', `${driver.name} - ${amount} ج.س`, 'active');
                
                // Show success message
                showAlert('success', 'تم خصم الرصيد بنجاح');
                
                // Reset form
                document.getElementById('deductDriverSelect').value = '';
                document.getElementById('deductAmount').value = '';
                document.getElementById('deductReason').value = 'penalty';
                document.getElementById('deductNote').value = '';
                
                // Reload data
                loadTransactions();
                loadDrivers();
            })
            .catch(error => {
                console.error('Error deducting from driver:', error);
                showAlert('danger', 'حدث خطأ أثناء خصم الرصيد');
            });
        }

        function loadTransactions() {
            const transactionsTable = document.getElementById('transactionsTable');
            transactionsTable.innerHTML = '<tr><td colspan="6" class="text-center"><div class="spinner"></div></td></tr>';
            
            db.collection('transactions')
                .orderBy('timestamp', 'desc')
                .limit(50)
                .get()
                .then(snapshot => {
                    transactionsTable.innerHTML = '';
                    
                    if (snapshot.empty) {
                        transactionsTable.innerHTML = '<tr><td colspan="6" class="text-center">لا توجد معاملات</td></tr>';
                        return;
                    }
                    
                    snapshot.forEach(doc => {
                        const transaction = doc.data();
                        const row = document.createElement('tr');
                        
                        let typeClass = '';
                        let typeText = '';
                        
                        switch(transaction.type) {
                            case 'recharge':
                                typeClass = 'status-active';
                                typeText = 'شحن';
                                break;
                            case 'deduction':
                                typeClass = 'status-inactive';
                                typeText = 'خصم';
                                break;
                        }
                        
                        row.innerHTML = `
                            <td>${formatDate(transaction.timestamp)}</td>
                            <td>${transaction.driverName}</td>
                            <td><span class="status-badge ${typeClass}">${typeText}</span></td>
                            <td>${transaction.amount} ج.س</td>
                            <td>${transaction.reason || transaction.note || '-'}</td>
                            <td>${transaction.adminId || 'System'}</td>
                        `;
                        
                        transactionsTable.appendChild(row);
                    });
                });
        }

        // Tracking Functions
        function loadTrackingData() {
            loadActiveDrivers();
            refreshMap();
        }

        function loadActiveDrivers() {
            const activeDriversTable = document.getElementById('activeDriversTable');
            activeDriversTable.innerHTML = '<tr><td colspan="5" class="text-center"><div class="spinner"></div></td></tr>';
            
            db.collection('drivers')
                .where('status', '==', 'active')
                .get()
                .then(snapshot => {
                    activeDriversTable.innerHTML = '';
                    
                    if (snapshot.empty) {
                        activeDriversTable.innerHTML = '<tr><td colspan="5" class="text-center">لا يوجد سائقين نشطين</td></tr>';
                        return;
                    }
                    
                    snapshot.forEach(doc => {
                        const driver = { id: doc.id, ...doc.data() };
                        const row = document.createElement('tr');
                        
                        row.innerHTML = `
                            <td>${driver.name}</td>
                            <td>${driver.currentLocation ? `${driver.currentLocation.lat}, ${driver.currentLocation.lng}` : 'غير محدد'}</td>
                            <td>${driver.lastLocationUpdate ? formatDate(driver.lastLocationUpdate) : 'غير محدد'}</td>
                            <td>${driver.todayTrips || 0}</td>
                            <td>
                                <button class="btn btn-sm btn-primary-custom" onclick="trackDriver('${driver.id}')">
                                    <i class="fas fa-map-marker-alt"></i>
                                </button>
                            </td>
                        `;
                        
                        activeDriversTable.appendChild(row);
                    });
                });
        }

        function refreshMap() {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // Load active drivers
            db.collection('drivers')
                .where('status', '==', 'active')
                .get()
                .then(snapshot => {
                    snapshot.forEach(doc => {
                        const driver = doc.data();
                        
                        if (driver.currentLocation) {
                            const marker = L.marker([driver.currentLocation.lat, driver.currentLocation.lng])
                                .addTo(map)
                                .bindPopup(`<b>${driver.name}</b><br>${driver.carModel} - ${driver.carPlate}`);
                            
                            markers.push(marker);
                        }
                    });
                });
        }

        function filterMapDrivers() {
            const driverId = document.getElementById('driverFilter').value;
            
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            if (!driverId) {
                refreshMap();
                return;
            }
            
            // Load specific driver
            db.collection('drivers').doc(driverId).get()
                .then(doc => {
                    if (doc.exists) {
                        const driver = doc.data();
                        
                        if (driver.currentLocation) {
                            const marker = L.marker([driver.currentLocation.lat, driver.currentLocation.lng])
                                .addTo(map)
                                .bindPopup(`<b>${driver.name}</b><br>${driver.carModel} - ${driver.carPlate}`);
                            
                            markers.push(marker);
                            
                            // Center map on driver
                            map.setView([driver.currentLocation.lat, driver.currentLocation.lng], 15);
                        }
                    }
                });
        }

        function trackDriver(driverId) {
            const driver = drivers.find(d => d.id === driverId);
            if (!driver || !driver.currentLocation) return;
            
            // Center map on driver
            map.setView([driver.currentLocation.lat, driver.currentLocation.lng], 16);
            
            // Show popup
            markers.forEach(marker => {
                if (marker.getLatLng().lat === driver.currentLocation.lat && 
                    marker.getLatLng().lng === driver.currentLocation.lng) {
                    marker.openPopup();
                }
            });
        }

        // Controls Functions
        function loadControlsData() {
            // Load settings
            db.collection('settings').doc('controls').get()
                .then(doc => {
                    if (doc.exists) {
                        const settings = doc.data();
                        
                        document.getElementById('tripNotifications').checked = settings.tripNotifications !== false;
                        document.getElementById('geofenceNotifications').checked = settings.geofenceNotifications !== false;
                        document.getElementById('lowBalanceNotifications').checked = settings.lowBalanceNotifications !== false;
                        document.getElementById('lowBalanceThreshold').value = settings.lowBalanceThreshold || 100;
                    }
                });
        }

        function suspendDriver() {
            const driverId = document.getElementById('suspendDriverSelect').value;
            const reason = document.getElementById('suspendReason').value;
            const duration = document.getElementById('suspendDuration').value;
            
            if (!driverId || !reason) {
                showAlert('warning', 'الرجاء اختيار سائق وإدخال سبب الإيقاف');
                return;
            }
            
            const driver = drivers.find(d => d.id === driverId);
            if (!driver) return;
            
            // Calculate suspension end date
            let suspensionEndDate = null;
            if (duration !== 'indefinite') {
                suspensionEndDate = new Date();
                suspensionEndDate.setDate(suspensionEndDate.getDate() + parseInt(duration));
            }
            
            // Update driver status
            db.collection('drivers').doc(driverId).update({
                status: 'suspended',
                suspensionReason: reason,
                suspensionEndDate: suspensionEndDate,
                suspendedAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                // Log activity
                logActivity('إيقاف السائق', `${driver.name} - ${reason}`, 'suspended');
                
                // Show success message
                showAlert('success', 'تم إيقاف السائق بنجاح');
                
                // Reset form
                document.getElementById('suspendDriverSelect').value = '';
                document.getElementById('suspendReason').value = '';
                document.getElementById('suspendDuration').value = '1';
                
                // Reload drivers
                loadDrivers();
            })
            .catch(error => {
                console.error('Error suspending driver:', error);
                showAlert('danger', 'حدث خطأ أثناء إيقاف السائق');
            });
        }

        function saveWorkArea() {
            const name = document.getElementById('workAreaName').value;
            const radius = parseFloat(document.getElementById('workAreaRadius').value);
            const center = document.getElementById('workAreaCenter').value;
            
            if (!name || !radius || !center) {
                showAlert('warning', 'الرجاء إدخال جميع بيانات منطقة العمل');
                return;
            }
            
            const [lat, lng] = center.split(',').map(coord => parseFloat(coord.trim()));
            
            if (isNaN(lat) || isNaN(lng)) {
                showAlert('warning', 'الرجاء إدخال إحداثيات صحيحة');
                return;
            }
            
            // Save work area to settings
            db.collection('settings').doc('workArea').set({
                name: name,
                center: { lat, lng },
                radius: radius,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                // Log activity
                logActivity('تحديث منطقة العمل', `${name} - نصف قطر ${radius} كم`, 'active');
                
                // Show success message
                showAlert('success', 'تم حفظ منطقة العمل بنجاح');
                
                // Add circle to map
                if (map) {
                    // Remove existing circle
                    if (window.workAreaCircle) {
                        map.removeLayer(window.workAreaCircle);
                    }
                    
                    // Add new circle
                    window.workAreaCircle = L.circle([lat, lng], {
                        color: '#6366F1',
                        fillColor: '#6366F1',
                        fillOpacity: 0.2,
                        radius: radius * 1000 // Convert km to meters
                    }).addTo(map);
                    
                    // Center map on work area
                    map.setView([lat, lng], 12);
                }
            })
            .catch(error => {
                console.error('Error saving work area:', error);
                showAlert('danger', 'حدث خطأ أثناء حفظ منطقة العمل');
            });
        }

        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    document.getElementById('workAreaCenter').value = `${lat}, ${lng}`;
                    
                    showAlert('success', 'تم تحديد الموقع الحالي بنجاح');
                }, error => {
                    console.error('Error getting location:', error);
                    showAlert('danger', 'حدث خطأ أثناء تحديد الموقع');
                });
            } else {
                showAlert('warning', 'المتصفح لا يدعم تحديد الموقع');
            }
        }

        // Reports Functions
        function loadReportsData() {
            // Initialize empty charts
            initializeCharts();
        }

        function initializeCharts() {
            // Revenue Chart
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            window.revenueChart = new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'الأرباح',
                        data: [],
                        backgroundColor: 'rgba(99, 102, 241, 0.2)',
                        borderColor: 'rgba(99, 102, 241, 1)',
                        borderWidth: 2,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Trips Chart
            const tripsCtx = document.getElementById('tripsChart').getContext('2d');
            window.tripsChart = new Chart(tripsCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'الرحلات',
                        data: [],
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function generateRevenueReport() {
            const period = document.getElementById('revenuePeriod').value;
            
            let startDate = new Date();
            let groupBy = 'day';
            
            switch(period) {
                case 'daily':
                    startDate.setDate(startDate.getDate() - 7);
                    break;
                case 'weekly':
                    startDate.setDate(startDate.getDate() - 30);
                    groupBy = 'week';
                    break;
                case 'monthly':
                    startDate.setMonth(startDate.getMonth() - 12);
                    groupBy = 'month';
                    break;
            }
            
            db.collection('transactions')
                .where('type', '==', 'recharge')
                .where('timestamp', '>=', startDate)
                .get()
                .then(snapshot => {
                    const data = {};
                    
                    snapshot.forEach(doc => {
                        const transaction = doc.data();
                        const date = new Date(transaction.timestamp.toDate());
                        let key;
                        
                        switch(groupBy) {
                            case 'day':
                                key = `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`;
                                break;
                            case 'week':
                                const weekStart = new Date(date);
                                weekStart.setDate(date.getDate() - date.getDay());
                                key = `${weekStart.getFullYear()}-${weekStart.getMonth() + 1}-${weekStart.getDate()}`;
                                break;
                            case 'month':
                                key = `${date.getFullYear()}-${date.getMonth() + 1}`;
                                break;
                        }
                        
                        if (!data[key]) {
                            data[key] = 0;
                        }
                        
                        data[key] += transaction.amount;
                    });
                    
                    // Update chart
                    const labels = Object.keys(data).sort();
                    const values = labels.map(label => data[label]);
                    
                    window.revenueChart.data.labels = labels;
                    window.revenueChart.data.datasets[0].data = values;
                    window.revenueChart.update();
                    
                    showAlert('success', 'تم إنشاء تقرير الأرباح بنجاح');
                })
                .catch(error => {
                    console.error('Error generating revenue report:', error);
                    showAlert('danger', 'حدث خطأ أثناء إنشاء تقرير الأرباح');
                });
        }

        function generateTripsReport() {
            const startDate = document.getElementById('tripStartDate').value;
            const endDate = document.getElementById('tripEndDate').value;
            
            if (!startDate || !endDate) {
                showAlert('warning', 'الرجاء اختيار تاريخ البداية والنهاية');
                return;
            }
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            end.setHours(23, 59, 59, 999);
            
            db.collection('trips')
                .where('date', '>=', start)
                .where('date', '<=', end)
                .get()
                .then(snapshot => {
                    const data = {};
                    
                    snapshot.forEach(doc => {
                        const trip = doc.data();
                        const date = new Date(trip.date.toDate());
                        const key = `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`;
                        
                        if (!data[key]) {
                            data[key] = 0;
                        }
                        
                        data[key]++;
                    });
                    
                    // Update chart
                    const labels = Object.keys(data).sort();
                    const values = labels.map(label => data[label]);
                    
                    window.tripsChart.data.labels = labels;
                    window.tripsChart.data.datasets[0].data = values;
                    window.tripsChart.update();
                    
                    showAlert('success', 'تم إنشاء تقرير الرحلات بنجاح');
                })
                .catch(error => {
                    console.error('Error generating trips report:', error);
                    showAlert('danger', 'حدث خطأ أثناء إنشاء تقرير الرحلات');
                });
        }

        function generateRankingReport() {
            const rankingTable = document.getElementById('rankingTable');
            rankingTable.innerHTML = '<tr><td colspan="5" class="text-center"><div class="spinner"></div></td></tr>';
            
            db.collection('drivers')
                .where('status', '==', 'active')
                .orderBy('totalTrips', 'desc')
                .limit(10)
                .get()
                .then(snapshot => {
                    rankingTable.innerHTML = '';
                    
                    if (snapshot.empty) {
                        rankingTable.innerHTML = '<tr><td colspan="5" class="text-center">لا توجد بيانات لعرضها</td></tr>';
                        return;
                    }
                    
                    let rank = 1;
                    snapshot.forEach(doc => {
                        const driver = doc.data();
                        const row = document.createElement('tr');
                        
                        let medal = '';
                        if (rank === 1) medal = '<i class="fas fa-trophy text-warning"></i>';
                        else if (rank === 2) medal = '<i class="fas fa-medal text-secondary"></i>';
                        else if (rank === 3) medal = '<i class="fas fa-medal text-danger"></i>';
                        
                        row.innerHTML = `
                            <td>${rank} ${medal}</td>
                            <td>${driver.name}</td>
                            <td>${driver.totalTrips || 0}</td>
                            <td>${driver.balance || 0} ج.س</td>
                            <td>${driver.rating || 0}</td>
                        `;
                        
                        rankingTable.appendChild(row);
                        rank++;
                    });
                    
                    showAlert('success', 'تم إنشاء تقرير الترتيب بنجاح');
                })
                .catch(error => {
                    console.error('Error generating ranking report:', error);
                    showAlert('danger', 'حدث خطأ أثناء إنشاء تقرير الترتيب');
                });
        }

        // Security Functions
        function loadSecurityData() {
            loadVerificationRequests();
            loadSecuritySettings();
        }

        function loadVerificationRequests() {
            const verificationTable = document.getElementById('verificationRequests');
            verificationTable.innerHTML = '<tr><td colspan="6" class="text-center"><div class="spinner"></div></td></tr>';
            
            db.collection('drivers')
                .where('status', '==', 'pending')
                .get()
                .then(snapshot => {
                    verificationTable.innerHTML = '';
                    
                    if (snapshot.empty) {
                        verificationTable.innerHTML = '<tr><td colspan="6" class="text-center">لا توجد طلبات توثيق معلقة</td></tr>';
                        return;
                    }
                    
                    snapshot.forEach(doc => {
                        const driver = { id: doc.id, ...doc.data() };
                        const row = document.createElement('tr');
                        
                        const hasDocuments = driver.documents.license || driver.documents.insurance || driver.documents.idCard;
                        
                        row.innerHTML = `
                            <td>${driver.name}</td>
                            <td>${driver.phone}</td>
                            <td>${hasDocuments ? 
                                `<span class="status-badge status-active">مكتمل</span>` : 
                                `<span class="status-badge status-pending">غير مكتمل</span>`
                            }</td>
                            <td>${formatDate(driver.createdAt)}</td>
                            <td><span class="status-badge status-pending">في الانتظار</span></td>
                            <td>
                                <button class="btn btn-sm btn-primary-custom me-1" onclick="viewDocuments('${driver.id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-success-custom" onclick="approveDriver('${driver.id}')">
                                    <i class="fas fa-check"></i>
                                </button>
                            </td>
                        `;
                        
                        verificationTable.appendChild(row);
                    });
                });
        }

        function loadSecuritySettings() {
            db.collection('settings').doc('security').get()
                .then(doc => {
                    if (doc.exists) {
                        const settings = doc.data();
                        
                        document.getElementById('requireDocuments').checked = settings.requireDocuments !== false;
                        document.getElementById('requirePhoneVerification').checked = settings.requirePhoneVerification !== false;
                        document.getElementById('documentExpiry').value = settings.documentExpiry || 365;
                        document.getElementById('maxLoginAttempts').value = settings.maxLoginAttempts || 5;
                    }
                });
        }

        function viewDocuments(driverId) {
            const driver = drivers.find(d => d.id === driverId);
            if (!driver) return;
            
            const content = document.getElementById('documentContent');
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <h5>رخصة القيادة</h5>
                        ${driver.documents.license ? 
                            `<img src="${driver.documents.license}" class="img-fluid" alt="License">` : 
                            '<p class="text-muted">لم يتم رفع المستند</p>'
                        }
                    </div>
                    <div class="col-md-4">
                        <h5>التأمين</h5>
                        ${driver.documents.insurance ? 
                            `<img src="${driver.documents.insurance}" class="img-fluid" alt="Insurance">` : 
                            '<p class="text-muted">لم يتم رفع المستند</p>'
                        }
                    </div>
                    <div class="col-md-4">
                        <h5>بطاقة الهوية</h5>
                        ${driver.documents.idCard ? 
                            `<img src="${driver.documents.idCard}" class="img-fluid" alt="ID Card">` : 
                            '<p class="text-muted">لم يتم رفع المستند</p>'
                        }
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h5>معلومات السائق</h5>
                        <p><strong>الاسم:</strong> ${driver.name}</p>
                        <p><strong>رقم الهاتف:</strong> ${driver.phone}</p>
                        <p><strong>البريد الإلكتروني:</strong> ${driver.email || 'غير محدد'}</p>
                    </div>
                </div>
            `;
            
            // Set approve button data
            document.getElementById('approveDocumentBtn').setAttribute('data-driver-id', driverId);
            document.getElementById('rejectDocumentBtn').setAttribute('data-driver-id', driverId);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('documentModal'));
            modal.show();
        }

        function approveDriver(driverId) {
            const driver = drivers.find(d => d.id === driverId);
            if (!driver) return;
            
            db.collection('drivers').doc(driverId).update({
                status: 'active',
                verifiedAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                // Log activity
                logActivity('موافقة على توثيق السائق', driver.name, 'active');
                
                // Show success message
                showAlert('success', 'تمت الموافقة على توثيق السائق بنجاح');
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('documentModal'));
                modal.hide();
                
                // Reload data
                loadVerificationRequests();
                loadDrivers();
            })
            .catch(error => {
                console.error('Error approving driver:', error);
                showAlert('danger', 'حدث خطأ أثناء الموافقة على السائق');
            });
        }

        function saveSecuritySettings() {
            const settings = {
                requireDocuments: document.getElementById('requireDocuments').checked,
                requirePhoneVerification: document.getElementById('requirePhoneVerification').checked,
                documentExpiry: parseInt(document.getElementById('documentExpiry').value),
                maxLoginAttempts: parseInt(document.getElementById('maxLoginAttempts').value),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            db.collection('settings').doc('security').set(settings)
            .then(() => {
                // Log activity
                logActivity('تحديث إعدادات الأمان', 'System', 'active');
                
                // Show success message
                showAlert('success', 'تم حفظ إعدادات الأمان بنجاح');
            })
            .catch(error => {
                console.error('Error saving security settings:', error);
                showAlert('danger', 'حدث خطأ أثناء حفظ إعدادات الأمان');
            });
        }

        // Utility Functions
        function logActivity(action, details, status) {
            db.collection('activities').add({
                action: action,
                details: details,
                status: status,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                adminId: auth.currentUser.uid
            });
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'غير محدد';
            
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('ar-SA', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'danger'} alert-dismissible fade show position-fixed`;
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.style.minWidth = '300px';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
    </script>
</body>
</html>
